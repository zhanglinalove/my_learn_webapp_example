{"version":3,"sources":["../../src/middlewares/auth.js"],"names":["config","require","UserModel","authUser","req","res","next","locals","currentUser","session","user","console","log","authToken","signedCookies","cookieName","findOne","_id","err","toObject","name","isAdmin","admin","loginname","adminRequired","Error","status","module","exports"],"mappings":";;AAAA,IAAIA,SAASC,QAAQ,WAAR,CAAb;AACA,IAAIC,YAAYD,QAAS,gBAAT,CAAhB;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASE,QAAT,CAAkBC,GAAlB,EAAuBC,GAAvB,EAA4BC,IAA5B,EAAkC;AAC9BD,MAAIE,MAAJ,CAAWC,WAAX,GAAyB,IAAzB;;AAEA,MAAIJ,IAAIK,OAAJ,IAAeL,IAAIK,OAAJ,CAAYC,IAA/B,EAAqC;AACnC,QAAMA,OAAON,IAAIK,OAAJ,CAAYC,IAAzB;AACAL,QAAIE,MAAJ,CAAWC,WAAX,GAAyBE,IAAzB;AACAC,YAAQC,GAAR,CAAYP,IAAIE,MAAJ,CAAWC,WAAvB;;AAEAF;AAED,GAPD,MAOO;AACL,QAAMO,YAAYT,IAAIU,aAAJ,CAAkBd,OAAOe,UAAzB,KAAwC,EAA1D;AACAJ,YAAQC,GAAR,CAAYC,SAAZ;;AAGA,QAAIA,SAAJ,EAAe;;AAEbX,gBAAUc,OAAV,CAAkB,EAAEC,KAAKJ,SAAP,EAAlB,EAAsC,UAASK,GAAT,EAAcR,IAAd,EAAoB;AACxD,YAAIQ,GAAJ,EAAS;AACPZ;AACD,SAFD,MAEO;AACLI,iBAAOA,KAAKS,QAAL,EAAP;AACAR,kBAAQC,GAAR,CAAYF,KAAKU,IAAjB;AACAV,eAAKW,OAAL,GAAeX,KAAKU,IAAL,KAAcpB,OAAOsB,KAApC;AACAX,kBAAQC,GAAR,CAAYZ,OAAOsB,KAAP,GAAe,KAAf,GAAuBZ,KAAKU,IAA5B,GAAmC,MAAnC,GAA4CV,KAAKa,SAA7D;;AAEAnB,cAAIK,OAAJ,CAAYC,IAAZ,GAAmBA,IAAnB;AACAL,cAAIE,MAAJ,CAAWC,WAAX,GAAyBE,IAAzB;AACAJ;AACD;AACF,OAbD;AAcD,KAhBD,MAgBO;AACLK,cAAQC,GAAR,CAAY,KAAZ;;AAEAN;AACD;AACF;AACF;;AAED,SAASkB,aAAT,CAAuBpB,GAAvB,EAA4BC,GAA5B,EAAiCC,IAAjC,EAAuC;AACrC,MAAI,CAACF,IAAIK,OAAL,IAAgB,CAACL,IAAIK,OAAJ,CAAYC,IAAjC,EAAuC;AACrC,QAAIQ,MAAM,IAAIO,KAAJ,CAAU,MAAV,CAAV;AACAP,QAAIQ,MAAJ,GAAa,GAAb;AACApB,SAAKY,GAAL;AACA;AACD;;AAED,MAAI,CAACd,IAAIK,OAAJ,CAAYC,IAAZ,CAAiBW,OAAtB,EAA+B;AAC7B,QAAIH,OAAM,IAAIO,KAAJ,CAAU,SAAV,CAAV;AACAP,SAAIQ,MAAJ,GAAa,GAAb;AACApB,SAAKY,IAAL;AACA;AACD;;AAEDZ;AACD;;AAEHqB,OAAOC,OAAP,GAAiB,EAAEzB,kBAAF,EAAYqB,4BAAZ,EAAjB","file":"auth.js","sourcesContent":["var config = require('../config');\nvar UserModel = require ('../models/user');\n\n\n// function authUser (req ,res ,next ){\n//     const authToken = req.signedCookies[ config.cookieName] || '';\n//     res.locals.currentUser = null;\n//     if(authToken){\n//         UserModel.findOne ({_id :authToken}, function(err , user){\n//            if(err){\n//                next();\n//            } else{\n//                res.locals.currentUser = user;\n//                next();\n        \n//            }\n//         });\n//     } else {\n//         next();\n//     }\n// }\n\nfunction authUser(req, res, next) {\n    res.locals.currentUser = null;\n  \n    if (req.session && req.session.user) {\n      const user = req.session.user;\n      res.locals.currentUser = user;\n      console.log(res.locals.currentUser);\n      \n      next();\n\n    } else {\n      const authToken = req.signedCookies[config.cookieName] || '';\n      console.log(authToken);\n\n  \n      if (authToken) {\n        \n        UserModel.findOne({ _id: authToken }, function(err, user) {\n          if (err) {\n            next();\n          } else {\n            user = user.toObject();\n            console.log(user.name);\n            user.isAdmin = user.name === config.admin;\n            console.log(config.admin + '---' + user.name + '+++ ' + user.loginname);\n  \n            req.session.user = user;\n            res.locals.currentUser = user;\n            next();\n          }\n        });\n      } else {\n        console.log(\"111\");\n\n        next();\n      }\n    }\n  }\n\n  function adminRequired(req, res, next) {\n    if (!req.session || !req.session.user) {\n      let err = new Error('需要登录');\n      err.status = 403;\n      next(err);\n      return;\n    }\n  \n    if (!req.session.user.isAdmin) {\n      let err = new Error('需要管理员权限');\n      err.status = 403;\n      next(err);\n      return;\n    }\n  \n    next();\n  }\n\nmodule.exports = { authUser ,adminRequired};"]}